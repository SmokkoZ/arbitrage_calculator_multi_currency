<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Surebet Ops Console</title>
    <link rel="stylesheet" href="style.css" />

    <!-- Optional favicon hook (put favicon.png in same folder) -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="favicon.png" />
    <link rel="apple-touch-icon" href="favicon.png" />
    <meta name="theme-color" content="#0a0f1f" />
</head>

<body>
    <div class="app-shell">
        <!-- HEADER -->
        <header class="header-card glass-card">
            <div class="header-main">
                <h1>Arbitrage Calculator</h1>
                <p class="tagline">2-way sizing, FX-locked, tax-aware ðŸ‡·ðŸ‡´</p>
            </div>

            <div class="fx-fetch-block">
                <button id="fetchRatesBtn" class="btn-primary">Fetch Rates (EUR base)</button>
                <div class="fetch-hint">
                    Snapshot once per 24h for accounting.
                </div>
                <div id="fetchStatus" class="status-msg"></div>
            </div>
        </header>

        <main class="main-col">

            <!-- ================= FX SNAPSHOT CARD ================= -->
            <section class="glass-card panel panel-compact">
                <div class="panel-head-row">
                    <h2 class="panel-title small-gap">
                        FX Snapshot (EUR â†’)
                    </h2>
                    <div id="fxTimestamp" class="fx-timestamp tiny-ts">No rates loaded</div>
                </div>

                <div id="fxTable" class="fx-table fx-table-inline">
                    <!-- populated by JS -->
                </div>

                <details class="manual-wrapper">
                    <summary class="manual-summary">
                        Manual rates override
                        <span class="manual-hint">(use if API blocked)</span>
                    </summary>

                    <div class="inline-manual">
                        <div class="manual-row">
                            <label for="manualGBP">1â‚¬ =</label>
                            <input type="number" step="0.0001" id="manualGBP" placeholder="GBP" />
                            <span class="manual-cur">GBP</span>
                        </div>

                        <div class="manual-row">
                            <label for="manualRON">1â‚¬ =</label>
                            <input type="number" step="0.0001" id="manualRON" placeholder="RON" />
                            <span class="manual-cur">RON</span>
                        </div>

                        <div class="manual-row">
                            <label for="manualAUD">1â‚¬ =</label>
                            <input type="number" step="0.0001" id="manualAUD" placeholder="AUD" />
                            <span class="manual-cur">AUD</span>
                        </div>

                        <button class="btn-primary wide" id="saveManualBtn">Save Manual Rates</button>

                        <div class="field-hint" style="margin-top:0.5rem;">
                            Saves locally and locks calculator to this snapshot.
                        </div>
                    </div>
                </details>
            </section>

            <!-- ================= CALCULATOR CARD ================= -->
            <section class="glass-card panel">
                <h2 class="panel-title">Surebet Sizing</h2>

                <!-- MODE TOGGLE -->
                <div class="note-box mode-box">
                    <div class="mode-option">
                        <label class="mode-label">
                            <input type="radio" name="calcMode" value="stakeA" id="modeStakeA" checked />
                            <div>
                                <div class="mode-title">I know Stake A</div>
                                <div class="mode-desc">
                                    I enter Stake A cash. You solve Stake B cash.
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="mode-option">
                        <label class="mode-label">
                            <input type="radio" name="calcMode" value="stakeB" id="modeStakeB" />
                            <div>
                                <div class="mode-title">I know Stake B</div>
                                <div class="mode-desc">
                                    I enter Stake B cash. You solve Stake A cash.
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="mode-option">
                        <label class="mode-label">
                            <input type="radio" name="calcMode" value="targetEUR" id="modeTargetEUR" />
                            <div>
                                <div class="mode-title">Target guaranteed payout in EUR</div>
                                <div class="mode-desc">
                                    I enter the EUR I want guaranteed. You solve both stakes.
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- FORM -->
                <form id="calcForm" class="calc-form">

                    <!-- SIDE A -->
                    <div class="h-row">
                        <div class="field slim">
                            <label for="oddsA">Odds A</label>
                            <input type="number" step="0.0001" id="oddsA" placeholder="e.g. 1.53" required />
                        </div>

                        <div class="field slim">
                            <label for="currencyA">Curr A</label>
                            <select id="currencyA">
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="RON">RON ðŸ‡·ðŸ‡´</option>
                                <option value="AUD">AUD</option>
                            </select>
                        </div>

                        <div class="field slim">
                            <label for="stakeA">Stake A cash in</label>
                            <input type="number" step="0.01" id="stakeA" placeholder="e.g. 100" />
                            <div class="tiny-hint-line">
                                Used in "I know Stake A".
                            </div>
                        </div>
                    </div>

                    <!-- SIDE B -->
                    <div class="h-row">
                        <div class="field slim">
                            <label for="oddsB">Odds B</label>
                            <input type="number" step="0.0001" id="oddsB" placeholder="e.g. 2.80" required />
                        </div>

                        <div class="field slim">
                            <label for="currencyB">Curr B</label>
                            <select id="currencyB">
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="RON">RON ðŸ‡·ðŸ‡´</option>
                                <option value="AUD">AUD</option>
                            </select>
                        </div>

                        <div class="field slim">
                            <label for="stakeB">Stake B cash in</label>
                            <input type="number" step="0.01" id="stakeB" placeholder="e.g. 80" />
                            <div class="tiny-hint-line">
                                Used in "I know Stake B".
                            </div>
                        </div>
                    </div>

                    <!-- TARGET PAYOUT -->
                    <div class="h-row">
                        <div class="field slim">
                            <label for="targetPayout">Guaranteed payout target (EUR)</label>
                            <input type="number" step="0.01" id="targetPayout" placeholder="e.g. 200" />
                            <div class="tiny-hint-line">
                                Used in "Target guaranteed payout in EUR".
                            </div>
                        </div>
                    </div>

                    <div class="calc-btn-row">
                        <button class="btn-primary" id="calcBtn">Calculate</button>
                    </div>
                </form>

                <div id="calcError" class="error-msg hidden"></div>

                <!-- ================= RESULTS ================= -->
                <div id="calcResult" class="result-card hidden">
                    <!-- 1. YOUR STAKES -->
                    <h3>Your stakes (what to place)</h3>

                    <div class="stakes-block">
                        <div class="stake-side">
                            <div class="stake-side-header">
                                <span class="side-label">Side A</span>
                                <span class="side-odds" id="sideAOddsOut">@ ?</span>
                            </div>

                            <div class="stake-row">
                                <span class="stake-label">Cash in:</span>
                                <span class="stake-val" id="stakeACashOut">-</span>
                            </div>

                            <div class="stake-row">
                                <span class="stake-label">Slip stake after fee:</span>
                                <span class="stake-val" id="stakeAEffOut">-</span>
                            </div>
                        </div>

                        <div class="stake-side">
                            <div class="stake-side-header">
                                <span class="side-label">Side B</span>
                                <span class="side-odds" id="sideBOddsOut">@ ?</span>
                            </div>

                            <div class="stake-row">
                                <span class="stake-label">Cash in:</span>
                                <span class="stake-val" id="stakeBCashOut">-</span>
                            </div>

                            <div class="stake-row">
                                <span class="stake-label">Slip stake after fee:</span>
                                <span class="stake-val" id="stakeBEffOut">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- 2. OUTCOME SCENARIOS -->
                    <h4 class="subhead">If each side wins (after country taxes)</h4>

                    <div class="outcomes-grid">
                        <div class="outcome-card">
                            <div class="outcome-head">
                                <span class="outcome-title">If Side A wins</span>
                            </div>

                            <div class="outcome-row">
                                <span class="out-label">Cash you collect from A:</span>
                                <span class="out-val" id="collectAOut">-</span>
                            </div>

                            <div class="outcome-row">
                                <span class="out-label">Total cost you paid in:</span>
                                <span class="out-val" id="totalCostAOut">-</span>
                            </div>

                            <div class="outcome-row">
                                <span class="out-label">Profit after tax (EUR):</span>
                                <span class="out-val greenish" id="profitAEurOut">-</span>
                            </div>

                            <div class="outcome-row">
                                <span class="out-label">ROI after tax:</span>
                                <span class="out-val" id="roiAOut">-</span>
                            </div>
                        </div>

                        <div class="outcome-card">
                            <div class="outcome-head">
                                <span class="outcome-title">If Side B wins</span>
                            </div>

                            <div class="outcome-row">
                                <span class="out-label">Cash you collect from B:</span>
                                <span class="out-val" id="collectBOut">-</span>
                            </div>

                            <div class="outcome-row">
                                <span class="out-label">Total cost you paid in:</span>
                                <span class="out-val" id="totalCostBOut">-</span>
                            </div>

                            <div class="outcome-row">
                                <span class="out-label">Profit after tax (EUR):</span>
                                <span class="out-val greenish" id="profitBEurOut">-</span>
                            </div>

                            <div class="outcome-row">
                                <span class="out-label">ROI after tax:</span>
                                <span class="out-val" id="roiBOut">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- 3. GUARANTEED FLOOR -->
                    <div class="guarantee-block">
                        <div class="guarantee-row">
                            <span class="guarantee-label">Guaranteed profit floor (EUR):</span>
                            <span class="guarantee-val greenish" id="guaranteedProfitOut">-</span>
                        </div>
                        <div class="guarantee-row">
                            <span class="guarantee-label">Guaranteed ROI floor:</span>
                            <span class="guarantee-val" id="guaranteedRoiOut">-</span>
                        </div>
                        <div class="guarantee-row">
                            <span class="guarantee-label">Arbitrage check:</span>
                            <span class="guarantee-val" id="arbOut">-</span>
                        </div>
                    </div>

                    <div class="tiny-hint">
                        Romania retail logic: RON bets lose 5% upfront and, if that side wins, payout is taxed 4%.
                        Non-RON bets have no Romania fee/tax.
                        Profit/ROI shown in EUR using the current FX snapshot.
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer-card glass-card">
            <div class="foot-left">
                <strong>Local operator use only.</strong> One human. One machine.
            </div>
            <div class="foot-right">
                Snap FX â†’ Size bets â†’ Log EUR profit â†’ Settle later.
            </div>
        </footer>
    </div>

    <script>
        /****************************************************
         * GLOBAL STATE
         ****************************************************/
        let fxRates = null;
        let fxTimestamp = null;
        const RATES_STORAGE_KEY = "surebet_fx_snapshot_v2";

        const $ = (sel) => document.querySelector(sel);
        function setText(sel, txt) {
            const el = $(sel);
            if (el) el.textContent = txt;
        }
        function show(el) { el.classList.remove("hidden"); }
        function hide(el) { el.classList.add("hidden"); }

        /****************************************************
         * LOCAL STORAGE / 24h LOCK
         ****************************************************/
        function loadRatesFromStorage() {
            try {
                const raw = localStorage.getItem(RATES_STORAGE_KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (!parsed || !parsed.rates || !parsed.timestamp) return;

                fxRates = parsed.rates;
                fxTimestamp = parsed.timestamp;

                renderFxSnapshot();
                lockFetchBtnIfNeeded();
            } catch (_) { }
        }

        function saveRatesToStorage() {
            if (!fxRates || !fxTimestamp) return;
            const payload = { rates: fxRates, timestamp: fxTimestamp };
            localStorage.setItem(RATES_STORAGE_KEY, JSON.stringify(payload));
        }

        function msSince(ts) { return Date.now() - ts; }
        function isWithin24h(ts) {
            const ONE_DAY_MS = 24 * 60 * 60 * 1000;
            return msSince(ts) < ONE_DAY_MS;
        }

        function lockFetchBtnIfNeeded() {
            const btn = $("#fetchRatesBtn");
            const status = $("#fetchStatus");

            if (fxTimestamp && isWithin24h(fxTimestamp)) {
                btn.disabled = true;
                status.textContent = "Using cached rates (<24h).";
                status.classList.remove("bad");
                status.classList.add("good");
            } else {
                btn.disabled = false;
                status.textContent = "You can fetch fresh rates.";
                status.classList.remove("bad");
                status.classList.add("good");
            }
        }

        /****************************************************
         * FETCH RATES
         ****************************************************/
        async function fetchRates() {
            const btn = $("#fetchRatesBtn");
            const status = $("#fetchStatus");

            if (fxTimestamp && isWithin24h(fxTimestamp)) {
                status.textContent = "Already fetched in the last 24h.";
                status.classList.remove("bad");
                status.classList.add("good");
                btn.disabled = true;
                return;
            }

            btn.disabled = true;
            status.textContent = "Fetching...";
            status.classList.remove("good", "bad");

            try {
                // Frankfurter API
                const url = "https://api.frankfurter.dev/v1/latest?symbols=GBP,RON,AUD";
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error("HTTP " + res.status + " " + res.statusText);
                }
                const data = await res.json();
                const rawRates = data.rates || {};

                const newRates = {
                    "EUR": 1.0,
                    "GBP": Number(rawRates["GBP"] || 0),
                    "RON": Number(rawRates["RON"] || 0),
                    "AUD": Number(rawRates["AUD"] || 0),
                };

                fxRates = newRates;
                fxTimestamp = Date.now();
                saveRatesToStorage();
                renderFxSnapshot();

                const missing = [];
                ["EUR", "GBP", "RON", "AUD"].forEach(c => {
                    if (!newRates[c] || newRates[c] === 0) missing.push(c);
                });

                if (missing.length > 0) {
                    status.textContent = "Partial rates (missing " + missing.join(", ") + ").";
                    status.classList.remove("good");
                    status.classList.add("bad");
                } else {
                    status.textContent = "Rates updated.";
                    status.classList.remove("bad");
                    status.classList.add("good");
                }

            } catch (err) {
                console.error("Rate fetch failed:", err);
                status.textContent = "ERROR. Use manual override.";
                status.classList.remove("good");
                status.classList.add("bad");

                if (!fxTimestamp) {
                    btn.disabled = false;
                }
            }

            lockFetchBtnIfNeeded();
        }

        /****************************************************
         * MANUAL RATES SAVE
         ****************************************************/
        function saveManualRates() {
            const gbpVal = parseFloat($("#manualGBP").value);
            const ronVal = parseFloat($("#manualRON").value);
            const audVal = parseFloat($("#manualAUD").value);

            const status = $("#fetchStatus");

            if (!(gbpVal > 0 && ronVal > 0 && audVal > 0)) {
                status.textContent = "All manual rates must be > 0.";
                status.classList.remove("good");
                status.classList.add("bad");
                return;
            }

            fxRates = {
                "EUR": 1.0,
                "GBP": gbpVal,
                "RON": ronVal,
                "AUD": audVal,
            };
            fxTimestamp = Date.now();
            saveRatesToStorage();
            renderFxSnapshot();
            lockFetchBtnIfNeeded();

            status.textContent = "Manual rates saved.";
            status.classList.remove("bad");
            status.classList.add("good");
        }

        /****************************************************
         * RENDER FX SNAPSHOT
         ****************************************************/
        function renderFxSnapshot() {
            const tsEl = $("#fxTimestamp");
            const tbl = $("#fxTable");

            if (!fxRates) {
                tsEl.textContent = "No rates loaded";
                tbl.innerHTML = "";
                return;
            }

            const tsStr = new Date(fxTimestamp).toLocaleString();
            tsEl.textContent = tsStr + " (EUR base)";

            function safe(val) {
                return val && Number(val) > 0 ? Number(val).toFixed(4) : "â€”";
            }

            tbl.innerHTML = `
                <div class="fx-row fx-row-inline">
                    <div class="fx-cur">EUR</div>
                    <div class="fx-val">1.0000</div>
                </div>
                <div class="fx-row fx-row-inline">
                    <div class="fx-cur">GBP</div>
                    <div class="fx-val">${safe(fxRates.GBP)}</div>
                </div>
                <div class="fx-row fx-row-inline">
                    <div class="fx-cur">RON</div>
                    <div class="fx-val">${safe(fxRates.RON)}</div>
                </div>
                <div class="fx-row fx-row-inline">
                    <div class="fx-cur">AUD</div>
                    <div class="fx-val">${safe(fxRates.AUD)}</div>
                </div>
            `;
        }

        /****************************************************
         * FX HELPERS
         ****************************************************/
        function amountToEUR(amount, currency) {
            if (!fxRates || !fxRates[currency]) {
                throw new Error("Unsupported currency " + currency + " or FX not loaded.");
            }
            // fxRates[currency] is "1 EUR = fxRates[currency] CURRENCY"
            // so CURRENCY -> EUR is amount / rate
            return amount / fxRates[currency];
        }
        function amountFromEUR(amountEUR, currency) {
            if (!fxRates || !fxRates[currency]) {
                throw new Error("Unsupported currency " + currency + " or FX not loaded.");
            }
            return amountEUR * fxRates[currency];
        }

        /****************************************************
         * ARB CHECK
         ****************************************************/
        function arbAnalysis(oddsA, oddsB) {
            const invSum = (1 / oddsA) + (1 / oddsB);
            const hasArb = invSum < 1;
            const retFactor = 1 / invSum;
            const arbPct = (retFactor - 1) * 100;
            return { hasArb, arbPct };
        }

        /****************************************************
         * ROMANIA TAX HELPERS
         ****************************************************/
        function isRomania(currency) {
            return currency === "RON";
        }

        // cash -> effective stake on slip (after 5% fee if Romania)
        function effectiveStakeFromCash(stakeCash, currency) {
            if (isRomania(currency)) {
                return stakeCash * (1 - 0.05); // minus 5% upfront fee
            }
            return stakeCash;
        }

        // effective stake on slip -> cash needed
        function cashFromEffectiveStake(effStake, currency) {
            if (isRomania(currency)) {
                return effStake / (1 - 0.05); // reverse the 5%
            }
            return effStake;
        }

        // given final winner side, what do we actually collect, after country tax?
        function computeSideFinancials(odds, stakeCash, currency) {
            const effStake = effectiveStakeFromCash(stakeCash, currency);

            // gross payout if this side wins (before any payout withholding)
            const grossPayout = effStake * odds;

            // Romania takes 4% from payout when you cash a winning ticket
            const netPayout = isRomania(currency)
                ? grossPayout * (1 - 0.04)
                : grossPayout;

            return {
                currency,
                stakeCash,
                effStake,
                grossPayout,
                netPayout
            };
        }

        /****************************************************
         * SIZING LOGIC
         *
         * Goal: balance the guaranteed payout BEFORE country tax,
         * using the stake that actually goes on the slip (effective stake).
         *
         * Steps:
         *   - known side gives us effStakeKnown
         *   - we compute payoutKnown_native = effStakeKnown * oddsKnown
         *   - convert to EUR
         *   - replicate that EUR payout for the other side
         *   - solve for effStakeOther
         *   - backsolve to stakeCashOther
         ****************************************************/

        function solveFromStakeA(oddsA, oddsB, stakeA_cash, curA, curB) {
            // effective stake actually placed at A
            const effA = effectiveStakeFromCash(stakeA_cash, curA);

            // gross payout native for A (before payout tax)
            const payoutA_native = effA * oddsA;

            // convert that payout into EUR
            const payoutA_EUR = amountToEUR(payoutA_native, curA);

            // how big should effective stake B be to match that EUR payout?
            // payoutB_native = effB * oddsB
            // payoutB_EUR = toEUR(payoutB_native, curB) must equal payoutA_EUR
            // => payoutB_native = fromEUR(payoutA_EUR, curB)
            const payoutB_native_needed = amountFromEUR(payoutA_EUR, curB);

            const effB = payoutB_native_needed / oddsB;

            // now get stakeB_cash needed, reversing Romania 5% if needed
            const stakeB_cash = cashFromEffectiveStake(effB, curB);

            return {
                stakeA_cash,
                stakeB_cash
            };
        }

        function solveFromStakeB(oddsA, oddsB, stakeB_cash, curA, curB) {
            const effB = effectiveStakeFromCash(stakeB_cash, curB);
            const payoutB_native = effB * oddsB;
            const payoutB_EUR = amountToEUR(payoutB_native, curB);

            const payoutA_native_needed = amountFromEUR(payoutB_EUR, curA);
            const effA = payoutA_native_needed / oddsA;
            const stakeA_cash = cashFromEffectiveStake(effA, curA);

            return {
                stakeA_cash,
                stakeB_cash
            };
        }

        function solveFromTargetEUR(oddsA, oddsB, targetPayoutEUR, curA, curB) {
            // targetPayoutEUR is the gross payout BEFORE payout tax,
            // guaranteed on both sides.
            // For side A:
            // payoutA_native = fromEUR(targetPayoutEUR, curA)
            // payoutA_native = effA * oddsA  => effA = payoutA_native / oddsA
            const payoutA_native_target = amountFromEUR(targetPayoutEUR, curA);
            const effA = payoutA_native_target / oddsA;
            const stakeA_cash = cashFromEffectiveStake(effA, curA);

            // same for B
            const payoutB_native_target = amountFromEUR(targetPayoutEUR, curB);
            const effB = payoutB_native_target / oddsB;
            const stakeB_cash = cashFromEffectiveStake(effB, curB);

            return {
                stakeA_cash,
                stakeB_cash
            };
        }

        /****************************************************
         * FINAL SUMMARY / OUTCOMES
         ****************************************************/
        function summarizeOutcomes(
            oddsA,
            oddsB,
            stakeA_cash,
            stakeB_cash,
            curA,
            curB
        ) {
            // per-side tax model
            const sideA = computeSideFinancials(oddsA, stakeA_cash, curA);
            const sideB = computeSideFinancials(oddsB, stakeB_cash, curB);

            // total cash invested across both tickets, in EUR
            const totalCostEUR =
                amountToEUR(sideA.stakeCash, curA) +
                amountToEUR(sideB.stakeCash, curB);

            // Scenario A wins:
            // collect sideA.netPayout (in curA), sideB is zero
            const collectA_EUR = amountToEUR(sideA.netPayout, curA);
            const profitIfA_EUR = collectA_EUR - totalCostEUR;
            const roiIfA = profitIfA_EUR / totalCostEUR;

            // Scenario B wins:
            const collectB_EUR = amountToEUR(sideB.netPayout, curB);
            const profitIfB_EUR = collectB_EUR - totalCostEUR;
            const roiIfB = profitIfB_EUR / totalCostEUR;

            // guaranteed floor
            const guaranteedProfitEUR = Math.min(profitIfA_EUR, profitIfB_EUR);
            const guaranteedRoiPct = Math.min(roiIfA, roiIfB) * 100;

            return {
                sideA,
                sideB,
                totalCostEUR,
                collectA_EUR,
                collectB_EUR,
                profitIfA_EUR,
                profitIfB_EUR,
                roiIfA_pct: roiIfA * 100,
                roiIfB_pct: roiIfB * 100,
                guaranteedProfitEUR,
                guaranteedRoiPct
            };
        }

        /****************************************************
         * RENDER RESULTS
         ****************************************************/
        function renderResults(
            oddsA,
            oddsB,
            curA,
            curB,
            stakeA_cash,
            stakeB_cash,
            summary,
            arbInfo
        ) {
            // --- Your stakes ---
            // Side A
            setText("#sideAOddsOut", `@ ${oddsA.toFixed(2)}`);
            setText(
                "#stakeACashOut",
                `${stakeA_cash.toFixed(2)} ${curA}`
            );
            setText(
                "#stakeAEffOut",
                `${summary.sideA.effStake.toFixed(2)} ${curA}`
                + (isRomania(curA) ? " (after 5%)" : "")
            );

            // Side B
            setText("#sideBOddsOut", `@ ${oddsB.toFixed(2)}`);
            setText(
                "#stakeBCashOut",
                `${stakeB_cash.toFixed(2)} ${curB}`
            );
            setText(
                "#stakeBEffOut",
                `${summary.sideB.effStake.toFixed(2)} ${curB}`
                + (isRomania(curB) ? " (after 5%)" : "")
            );

            // --- Outcome A wins ---
            // Cash you collect from A (native currency A, after 4% if Romania)
            setText(
                "#collectAOut",
                `${summary.sideA.netPayout.toFixed(2)} ${curA} (after tax)`
            );
            // total cost in EUR is same for both outcomes
            setText(
                "#totalCostAOut",
                `${summary.totalCostEUR.toFixed(2)} EUR`
            );
            setText(
                "#profitAEurOut",
                `${summary.profitIfA_EUR.toFixed(2)} EUR`
            );
            setText(
                "#roiAOut",
                `${summary.roiIfA_pct.toFixed(2)} %`
            );

            // --- Outcome B wins ---
            setText(
                "#collectBOut",
                `${summary.sideB.netPayout.toFixed(2)} ${curB} (after tax)`
            );
            setText(
                "#totalCostBOut",
                `${summary.totalCostEUR.toFixed(2)} EUR`
            );
            setText(
                "#profitBEurOut",
                `${summary.profitIfB_EUR.toFixed(2)} EUR`
            );
            setText(
                "#roiBOut",
                `${summary.roiIfB_pct.toFixed(2)} %`
            );

            // --- Guaranteed floor ---
            setText(
                "#guaranteedProfitOut",
                `${summary.guaranteedProfitEUR.toFixed(2)} EUR`
            );
            setText(
                "#guaranteedRoiOut",
                `${summary.guaranteedRoiPct.toFixed(2)} %`
            );

            if (arbInfo.hasArb) {
                setText("#arbOut", `ARB âœ…  +${arbInfo.arbPct.toFixed(2)}%`);
            } else {
                setText("#arbOut", `NO ARB âŒ  ${arbInfo.arbPct.toFixed(2)}%`);
            }

            show($("#calcResult"));
        }

        /****************************************************
         * MODE UI HIGHLIGHT
         ****************************************************/
        function refreshModeUI() {
            const stakeAOption = document.querySelector('.mode-option:nth-of-type(1)');
            const stakeBOption = document.querySelector('.mode-option:nth-of-type(2)');
            const targetEUROption = document.querySelector('.mode-option:nth-of-type(3)');

            if ($("#modeStakeA").checked) {
                stakeAOption.classList.add("active");
                stakeBOption.classList.remove("active");
                targetEUROption.classList.remove("active");
            } else if ($("#modeStakeB").checked) {
                stakeBOption.classList.add("active");
                stakeAOption.classList.remove("active");
                targetEUROption.classList.remove("active");
            } else {
                targetEUROption.classList.add("active");
                stakeAOption.classList.remove("active");
                stakeBOption.classList.remove("active");
            }
        }

        /****************************************************
         * CALCULATE HANDLER
         ****************************************************/
        function onCalculate(e) {
            e.preventDefault();

            const errBox = $("#calcError");
            const resultBox = $("#calcResult");
            hide(errBox);

            // read inputs
            const oddsA = parseFloat($("#oddsA").value);
            const oddsB = parseFloat($("#oddsB").value);

            const curA = $("#currencyA").value;
            const curB = $("#currencyB").value;

            const stakeAVal = parseFloat($("#stakeA").value);
            const stakeBVal = parseFloat($("#stakeB").value);
            const targetPayoutVal = parseFloat($("#targetPayout").value);

            const mode = $("#modeStakeA").checked
                ? "stakeA"
                : $("#modeStakeB").checked
                    ? "stakeB"
                    : "targetEUR";

            // validation
            if (!fxRates) {
                errBox.textContent = "No FX snapshot loaded. Fetch or enter manual rates first.";
                show(errBox);
                hide(resultBox);
                return;
            }
            if (!(oddsA > 1 && oddsB > 1)) {
                errBox.textContent = "Odds must be > 1.00";
                show(errBox);
                hide(resultBox);
                return;
            }

            let stakeA_cash, stakeB_cash;
            try {
                if (mode === "stakeA") {
                    if (!(stakeAVal > 0)) {
                        throw new Error("Stake A must be > 0 in 'I know Stake A' mode.");
                    }
                    const solved = solveFromStakeA(
                        oddsA,
                        oddsB,
                        stakeAVal,
                        curA,
                        curB
                    );
                    stakeA_cash = solved.stakeA_cash;
                    stakeB_cash = solved.stakeB_cash;

                } else if (mode === "stakeB") {
                    if (!(stakeBVal > 0)) {
                        throw new Error("Stake B must be > 0 in 'I know Stake B' mode.");
                    }
                    const solved = solveFromStakeB(
                        oddsA,
                        oddsB,
                        stakeBVal,
                        curA,
                        curB
                    );
                    stakeA_cash = solved.stakeA_cash;
                    stakeB_cash = solved.stakeB_cash;

                } else {
                    if (!(targetPayoutVal > 0)) {
                        throw new Error("Target EUR must be > 0 in 'Target guaranteed payout in EUR' mode.");
                    }
                    const solved = solveFromTargetEUR(
                        oddsA,
                        oddsB,
                        targetPayoutVal,
                        curA,
                        curB
                    );
                    stakeA_cash = solved.stakeA_cash;
                    stakeB_cash = solved.stakeB_cash;
                }
            } catch (err) {
                errBox.textContent = err.message || String(err);
                show(errBox);
                hide(resultBox);
                return;
            }

            // Now build full summary with per-country tax logic
            let summary;
            try {
                summary = summarizeOutcomes(
                    oddsA,
                    oddsB,
                    stakeA_cash,
                    stakeB_cash,
                    curA,
                    curB
                );
            } catch (err) {
                errBox.textContent = err.message || String(err);
                show(errBox);
                hide(resultBox);
                return;
            }

            // Arbitrage check (pure odds math, classic surebet test)
            const arbInfo = arbAnalysis(oddsA, oddsB);

            renderResults(
                oddsA,
                oddsB,
                curA,
                curB,
                stakeA_cash,
                stakeB_cash,
                summary,
                arbInfo
            );
        }

        /****************************************************
         * INIT
         ****************************************************/
        function init() {
            $("#fetchRatesBtn").addEventListener("click", fetchRates);
            $("#calcBtn").addEventListener("click", onCalculate);

            const manualBtn = $("#saveManualBtn");
            if (manualBtn) {
                manualBtn.addEventListener("click", saveManualRates);
            }

            // mode highlight visuals
            $("#modeStakeA").addEventListener("change", refreshModeUI);
            $("#modeStakeB").addEventListener("change", refreshModeUI);
            $("#modeTargetEUR").addEventListener("change", refreshModeUI);
            refreshModeUI();

            loadRatesFromStorage();
            lockFetchBtnIfNeeded();
            renderFxSnapshot();
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>
